{javascript:
const fetch = require('node-fetch');

(async () => {
  const url = 'https://us.api.iheart.com/api/v3/live-meta/stream/1701/currentTrackMeta?defaultMetadata=true';
  const res = await fetch(url);
  const json = await res.json();

  // Safely traverse possible paths
  const d = json || {};
  const meta = d.currentTrackMeta || d.track || d || {};

  const artistId = meta.artistId ?? meta.artist?.id ?? null;
  const albumId = meta.albumId ?? meta.album?.id ?? null;
  const trackId = meta.trackId ?? meta.id ?? null;

  const title = meta.title ?? meta.trackTitle ?? '';
  const artist = meta.artistName ?? meta.artist?.name ?? '';
  const album = meta.albumName ?? meta.album?.name ?? '';

  const trackDuration =
    typeof meta.trackDuration === 'number' ? meta.trackDuration :
    typeof meta.duration === 'number' ? meta.duration :
    null;

  const imagePath =
    meta.imagePath ??
    meta.imageUrl ??
    meta.image ?? 
    (meta.album && (meta.album.image || meta.album.imageUrl)) ??
    null;

  const explicitLyrics =
    typeof meta.explicitLyrics === 'boolean' ? meta.explicitLyrics :
    typeof meta.explicit === 'boolean' ? meta.explicit :
    false;

  const startTime =
    typeof meta.startTime === 'number' ? meta.startTime :
    (meta.timestamps && typeof meta.timestamps.start === 'number' ? meta.timestamps.start : null);

  const endTime =
    typeof meta.endTime === 'number' ? meta.endTime :
    (meta.timestamps && typeof meta.timestamps.end === 'number' ? meta.timestamps.end : null);

  const playbackRights = meta.playbackRights || { onDemand: meta.onDemand === true };
  const dataSource = meta.dataSource || meta.source || 'Pnp';

  const shaped = {
    artistId,
    albumId,
    trackId,
    title,
    artist,
    album,
    trackDuration,
    imagePath,
    explicitLyrics,
    startTime,
    endTime,
    playbackRights,
    dataSource
  };

  const embed = {
    color: 0xFF6100,
    author: { name: artist || 'Unknown Artist' },
    title: title || 'Unknown Title',
    description: album ? `Album: ${album}` : undefined,
    thumbnail: imagePath ? { url: imagePath } : undefined,
    fields: [
      { name: 'Artist ID', value: String(artistId ?? 'N/A'), inline: true },
      { name: 'Album ID', value: String(albumId ?? 'N/A'), inline: true },
      { name: 'Track ID', value: String(trackId ?? 'N/A'), inline: true },
      { name: 'Duration (s)', value: String(trackDuration ?? 'N/A'), inline: true },
      { name: 'Explicit', value: String(explicitLyrics), inline: true },
      { name: 'On Demand', value: String(!!playbackRights?.onDemand), inline: true },
      { name: 'Start', value: startTime ? `<t:${Math.floor(startTime/1000)}:T>` : 'N/A', inline: true },
      { name: 'End', value: endTime ? `<t:${Math.floor(endTime/1000)}:T>` : 'N/A', inline: true },
      { name: 'Source', value: String(dataSource || 'N/A'), inline: true },
    ].filter(Boolean)
  };

  // Print shaped JSON then a newline, then special marker for embed JSON for TagScript to capture
  console.log(JSON.stringify(shaped, null, 2));
  console.log('\n__NSB_EMBED__' + JSON.stringify(embed));
})();
}
{set:raw|{python:
import os, sys, json
data = sys.stdin.read()
parts = data.split('__NSB_EMBED__')
shaped = parts[0].strip()
embed = json.loads(parts[1]) if len(parts) > 1 else {}
print(json.dumps({"shaped": shaped, "embed": embed}))
}}
{set:shaped|{traversejson:shaped|{get:raw}}}
{set:embed|{traversejson:embed|{get:raw}}}
{embedjson:{get:embed}}
{code:{get:shaped}}