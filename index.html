<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title id="title"></title>
<style>
h1 { border-bottom:1px solid #c0c0c0; margin-bottom:10px; padding-bottom:10px; white-space:nowrap; }
table { border-collapse: collapse; width: 100%; }
th { cursor: pointer; text-align: left; }
td.detailsColumn { padding-inline-start: 2em; text-align: end; white-space: nowrap; }
a.icon { padding-inline-start: 1.5em; text-decoration: none; }
a.icon:hover { text-decoration: underline; }
a.file { background : url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAABnRSTlMAAAAAAABupgeRAAABEElEQVR42nRRx3HDMBC846AHZ7sP54BmWAyrsP588qnwlhqw/k4v5ZwWxM1hzmGRgV1cYqrRarXoH2w2m6qqiqKIR6cPtzc3xMSML2Te7XZZlnW7Pe/91/dX47WRBHuA9oyGmRknzGDjab1ePzw8bLfb6WRalmW4ip9FDVpYSWZgOp12Oh3nXJ7nxoJSGEciteP9y+fH52q1euv38WosqA6T2gGOT44vry7BEQtJkMAMMpa6JagAMcUfWYa4hkkzAc7fFlSjwqCoOUYAF5RjHZPVCFBOtSBGfgUDji3c3jpibeEMQhIMh8NwshqyRsBJgvF4jMs/YlVR5KhgNpuBLzk0OcUiR3CMhcPaOzsZiAAA/AjmaB3WZIkAAAAASUVORK5CYII=") left top no-repeat; }
</style>
</head>
<body>
<h1 id="header">GitHub Repositories</h1>
<table>
  <thead>
    <tr id="theader">
      <th id="nameColumnHeader" tabindex="0">Name</th>
      <th id="sizeColumnHeader" class="detailsColumn" tabindex="0">Size (KB)</th>
      <th id="dateColumnHeader" class="detailsColumn" tabindex="0">Last Updated</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
async function addRow(name, url, size, updated_at) {
  const tbody = document.getElementById("tbody");
  const row = document.createElement("tr");

  const file_cell = document.createElement("td");
  const link = document.createElement("a");
  link.className = "icon file";
  link.innerText = name;
  link.href = url;
  link.target = "_blank";
  file_cell.appendChild(link);
  file_cell.dataset.value = name;
  row.appendChild(file_cell);

  const sizeCell = document.createElement("td");
  sizeCell.className = "detailsColumn";
  sizeCell.innerText = size;
  sizeCell.dataset.value = size;
  row.appendChild(sizeCell);

  const dateCell = document.createElement("td");
  dateCell.className = "detailsColumn";
  const timestamp = new Date(updated_at).getTime();
  dateCell.innerText = new Date(updated_at).toLocaleString();
  dateCell.dataset.value = timestamp;
  row.appendChild(dateCell);

  tbody.appendChild(row);
}

function sortTable(column) {
  const theader = document.getElementById("theader");
  let oldOrder = theader.cells[column].dataset.order || '1';
  oldOrder = parseInt(oldOrder);
  const newOrder = -oldOrder;
  theader.cells[column].dataset.order = newOrder;

  const tbody = document.getElementById("tbody");
  const rows = Array.from(tbody.rows);

  rows.sort((a, b) => {
    let valA = a.cells[column].dataset.value;
    let valB = b.cells[column].dataset.value;
    if (column === 0) return valA > valB ? newOrder : valA < valB ? oldOrder : 0;
    valA = parseFloat(valA);
    valB = parseFloat(valB);
    return valA > valB ? newOrder : valA < valB ? oldOrder : 0;
  });

  rows.forEach(r => tbody.appendChild(r));
}

function addHandlers(element, column) {
  element.onclick = () => sortTable(column);
  element.onkeydown = (e) => { if(e.key=='Enter'||e.key==' ') { sortTable(column); e.preventDefault(); } };
}

async function fetchRepoContents(user, repo) {
  try {
    const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents`;
    const res = await fetch(apiUrl);
    const files = await res.json();
    files.forEach(f => {
      if(f.type === "file") addRow(`${repo}/${f.name}`, f.download_url, "-", f.sha);
    });
  } catch (e) {
    console.error("Failed to fetch repo contents", e);
  }
}

async function onLoad() {
  addHandlers(document.getElementById('nameColumnHeader'), 0);
  addHandlers(document.getElementById('sizeColumnHeader'), 1);
  addHandlers(document.getElementById('dateColumnHeader'), 2);

  let params = new URLSearchParams(window.location.search);
  let username = params.get('username') || "giggityfiles";

  document.getElementById('header').innerText = `GitHub Repositories of ${username}`;

  try {
    const res = await fetch(`https://api.github.com/users/${username}/repos?per_page=100`);
    let repos = await res.json();
    if(!Array.isArray(repos)) throw "No repos";

    for (let repo of repos) {
      if (repo.name.includes("github.io")) {
        // fetch individual files in the github.io repo
        await fetchRepoContents(username, repo.name);
      } else {
        await addRow(repo.name, repo.html_url, repo.size, repo.updated_at);
      }
    }
  } catch (e) {
    if(username !== "giggityfiles") {
      // fallback to giggityfiles if something fails
      username = "giggityfiles";
      onLoad();
    } else {
      alert("Failed to fetch repositories.");
    }
  }
}

window.addEventListener('DOMContentLoaded', onLoad);
</script>
</body>
</html>
