<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CMD-Archive</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:900px; margin:2rem auto; padding:0 1rem; color:#111; }
    header { display:flex; gap:1rem; align-items:center; margin-bottom:1rem; }
    h1 { margin:0; font-size:1.25rem; }
    .controls { display:flex; gap:.5rem; margin-bottom:1rem; flex-wrap:wrap; }
    button { padding:.5rem .75rem; font-size:0.95rem; cursor:pointer; }
    ul { list-style:none; padding:0; margin:0.5rem 0 2rem 0; }
    li { padding:.35rem .5rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; gap:1rem; }
    a.file { color:#0366d6; text-decoration:none; }
    a.file:hover { text-decoration:underline; }
    .meta { color:#555; font-size:0.9rem; }
    .small { font-size:0.9rem; color:#444; }
    .error { color:#b00020; }
  </style>
</head>
<body>

<header>
  <h1>CMD-Archive</h1>
</header>

<section class="controls">
  <button id="loadBtn">Load HTML files</button>
  <button id="refreshBtn">Refresh</button>
</section>

<div id="status" class="small"></div>
<ul id="files"></ul>

<p class="small">
  Uses the GitHub <code>/contents</code> API and lists all <code>.html</code> files recursively.
</p>

<script>
(() => {
  const owner = "cmd-hue";
  const repo  = "archive";
  const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents`;

  const filesEl = document.getElementById("files");
  const statusEl = document.getElementById("status");
  const loadBtn = document.getElementById("loadBtn");
  const refreshBtn = document.getElementById("refreshBtn");

  function encodePath(path) {
    return path.split("/").map(encodeURIComponent).join("/");
  }

  async function apiFetch(url) {
    const res = await fetch(url, {
      headers: { "Accept": "application/vnd.github+json" }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  async function getPagesBase() {
    try {
      const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/pages`);
      if (r.ok) {
        const j = await r.json();
        return j.html_url.replace(/\/$/, "") + "/";
      }
    } catch {}
    return `https://${owner}.github.io/${repo}/`;
  }

  async function walkContents(path = "", results = []) {
    const url = path ? `${apiBase}/${encodePath(path)}` : apiBase;
    const items = await apiFetch(url);

    for (const item of items) {
      if (item.type === "dir") {
        await walkContents(item.path, results);
      } else if (item.type === "file" && item.name.toLowerCase().endsWith(".html")) {
        results.push(item);
      }
    }
    return results;
  }

  async function loadFiles() {
    filesEl.innerHTML = "";
    statusEl.textContent = "Scanning repositoryâ€¦";
    loadBtn.disabled = refreshBtn.disabled = true;

    try {
      const pagesBase = await getPagesBase();
      const files = await walkContents();

      if (!files.length) {
        statusEl.textContent = "No HTML files found.";
        return;
      }

      files.sort((a, b) => a.path.localeCompare(b.path));
      statusEl.textContent = `Found ${files.length} HTML file(s).`;

      for (const f of files) {
        const li = document.createElement("li");

        const a = document.createElement("a");
        a.className = "file";
        a.href = pagesBase + encodePath(f.path);
        a.textContent = f.path;
        a.target = "_blank";
        a.rel = "noopener";

        const meta = document.createElement("span");
        meta.className = "meta";
        meta.textContent = f.size ? `${f.size} bytes` : "";

        li.appendChild(a);
        li.appendChild(meta);
        filesEl.appendChild(li);
      }

    } catch (e) {
      console.error(e);
      statusEl.innerHTML = `<span class="error">Failed to load repository contents.</span>`;
    } finally {
      loadBtn.disabled = refreshBtn.disabled = false;
    }
  }

  loadBtn.onclick = loadFiles;
  refreshBtn.onclick = loadFiles;
  loadFiles();
})();
</script>

</body>
</html>
